<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom" xmlns:content="http://purl.org/rss/1.0/modules/content/">
  <channel>
    <title>Posts on Shenlong616</title>
    <link>https://shenlong616.github.io/posts/</link>
    <description>Recent content in Posts on Shenlong616</description>
    <generator>Hugo -- gohugo.io</generator>
    <lastBuildDate>Thu, 14 Jul 2022 00:00:00 +0000</lastBuildDate><atom:link href="https://shenlong616.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>iptables</title>
      <link>https://shenlong616.github.io/posts/iptables/</link>
      <pubDate>Thu, 14 Jul 2022 00:00:00 +0000</pubDate>
      
      <guid>https://shenlong616.github.io/posts/iptables/</guid>
      <description>Basic firewall rules # 1: Drop invalid packets /sbin/iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP # 2: Drop TCP packets that are new and are not SYN /sbin/iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP # 3: Drop SYN packets with suspicious MSS value /sbin/iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP # 4: Block packets with bogus TCP flags /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,RST SYN,RST -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,RST FIN,RST -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,ACK FIN -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,URG URG -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,FIN FIN -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,PSH PSH -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL ALL -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL NONE -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP /sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP # 5: Block spoofed packets /sbin/iptables -t mangle -A PREROUTING -s 224.</description>
      <content:encoded><![CDATA[<h3 id="basic-firewall-rules">Basic firewall rules</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 1: Drop invalid packets</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -m conntrack --ctstate INVALID -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 2: Drop TCP packets that are new and are not SYN</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp ! --syn -m conntrack --ctstate NEW -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 3: Drop SYN packets with suspicious MSS value</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp -m conntrack --ctstate NEW -m tcpmss ! --mss 536:65535 -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 4: Block packets with bogus TCP flags</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN,RST,PSH,ACK,URG NONE -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,SYN FIN,SYN -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,RST SYN,RST -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags SYN,FIN SYN,FIN -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,RST FIN,RST -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags FIN,ACK FIN -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,URG URG -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,FIN FIN -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ACK,PSH PSH -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL ALL -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL NONE -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL FIN,PSH,URG -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,FIN,PSH,URG -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p tcp --tcp-flags ALL SYN,RST,ACK,FIN,URG -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 5: Block spoofed packets</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 224.0.0.0/3 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 169.254.0.0/16 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 172.16.0.0/12 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 192.0.2.0/24 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 192.168.0.0/16 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 10.0.0.0/8 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 0.0.0.0/8 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 240.0.0.0/5 -j DROP
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -s 127.0.0.0/8 ! -i lo -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 6: Drop ICMP (you usually don&#39;t need this protocol)</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -p icmp -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 7: Drop fragments in all chains</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -A PREROUTING -f -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 8: Limit connections per source IP</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp -m connlimit --connlimit-above <span class="m">111</span> -j REJECT --reject-with tcp-reset
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 9: Limit RST packets</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp --tcp-flags RST RST -m limit --limit 2/s --limit-burst <span class="m">2</span> -j ACCEPT
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp --tcp-flags RST RST -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 10a: Limit new TCP connections per second per source IP</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp -m conntrack --ctstate NEW -m limit --limit 60/s --limit-burst <span class="m">30</span> -j ACCEPT
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp -m conntrack --ctstate NEW -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 10b: Limit new UDP connections per second per source IP</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p udp -m conntrack --ctstate NEW -m limit --limit 60/s --limit-burst <span class="m">30</span> -j ACCEPT
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p udp -m conntrack --ctstate NEW -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 11: Use SYNPROXY on all ports (disables connection limiting rule)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#/sbin/iptables -t raw -D PREROUTING -p tcp -m tcp --syn -j CT --notrack</span>
</span></span><span class="line"><span class="cl"><span class="c1">#/sbin/iptables -D INPUT -p tcp -m tcp -m conntrack --ctstate INVALID,UNTRACKED -j SYNPROXY --sack-perm --timestamp --wscale 7 --mss 1460</span>
</span></span><span class="line"><span class="cl"><span class="c1">#/sbin/iptables -D INPUT -m conntrack --ctstate INVALID -j DROP</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 12: SSH brute-force protection</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp --dport ssh -m conntrack --ctstate NEW -m recent --set
</span></span><span class="line"><span class="cl">/sbin/iptables -A INPUT -p tcp --dport ssh -m conntrack --ctstate NEW -m recent --update --seconds <span class="m">60</span> --hitcount <span class="m">10</span> -j DROP
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 13: Protection against port scanning</span>
</span></span><span class="line"><span class="cl">/sbin/iptables -N portScanning
</span></span><span class="line"><span class="cl">/sbin/iptables -A portScanning -p tcp --tcp-flags SYN,ACK,FIN,RST RST -m limit --limit 1/s --limit-burst <span class="m">2</span> -j RETURN
</span></span><span class="line"><span class="cl">/sbin/iptables -A portScanning -j DROP
</span></span></code></pre></div><h3 id="flushing-all-rules">Flushing all rules</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/sbin/iptables -t filter -F
</span></span><span class="line"><span class="cl">/sbin/iptables -t nat -F
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -F
</span></span><span class="line"><span class="cl">/sbin/iptables -t raw -F
</span></span><span class="line"><span class="cl">/sbin/iptables -t security -F
</span></span><span class="line"><span class="cl">/sbin/iptables -F
</span></span></code></pre></div><h3 id="deleting-all-chains">Deleting all chains</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/sbin/iptables -t filter -X
</span></span><span class="line"><span class="cl">/sbin/iptables -t nat -X
</span></span><span class="line"><span class="cl">/sbin/iptables -t mangle -X
</span></span><span class="line"><span class="cl">/sbin/iptables -t raw -X
</span></span><span class="line"><span class="cl">/sbin/iptables -t security -X
</span></span><span class="line"><span class="cl">/sbin/iptables -X
</span></span></code></pre></div><h3 id="accepting-all">Accepting all</h3>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">/sbin/iptables -P INPUT ACCEPT
</span></span><span class="line"><span class="cl">/sbin/iptables -P OUTPUT ACCEPT
</span></span><span class="line"><span class="cl">/sbin/iptables -P FORWARD ACCEPT
</span></span></code></pre></div><h3 id="tor-exit-node-blocking-with">Tor Exit Node Blocking with</h3>
<ul>
<li>torproject.org</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">ipset -N torBulkExitList iphash
</span></span><span class="line"><span class="cl">curl <span class="s1">&#39;https://check.torproject.org/torbulkexitlist?ip=&#39;</span> <span class="p">|</span> xargs -n <span class="m">1</span> ipset -A torBulkExitList
</span></span><span class="line"><span class="cl">iptables -A INPUT -m <span class="nb">set</span> --match-set torBulkExitList src -j DROP
</span></span></code></pre></div><h3 id="others">Others</h3>
<ul>
<li><a href="https://unix.stackexchange.com/a/52378">Why do iptables rules disappear when restarting my Debian system?</a></li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ iptables-save &gt; /etc/iptables.conf
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ <span class="nb">echo</span> <span class="s1">&#39;iptables-restore &lt; /etc/iptables.conf&#39;</span> &gt;&gt; /etc/rc.d/rc.local
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ chmod +x /etc/rc.d/rc.local
</span></span></code></pre></div>]]></content:encoded>
    </item>
    
  </channel>
</rss>
